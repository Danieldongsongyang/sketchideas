# ShipAny Template Two 架构图

## 整体架构概览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Next.js 16 应用层                                  │
│                        (App Router + 国际化路由)                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                 ┌────────────────────┼────────────────────┐
                 │                    │                    │
                 ▼                    ▼                    ▼
    ┌─────────────────────┐ ┌──────────────────┐ ┌─────────────────┐
    │                     │ │                  │ │                 │
    │      路由组          │ │    API 路由      │ │   内容管理       │
    │                     │ │                  │ │                 │
    │  • (admin) 管理后台  │ │  • /api/auth/*   │ │  • MDX 内容     │
    │  • (auth)  认证页面  │ │  • /api/ai/*     │ │  • 文档系统     │
    │  • (chat)  聊天功能  │ │  • /api/payment/* │ │  • 博客文章     │
    │  • (docs)  文档页面  │ │  • /api/storage/* │ │                 │
    │  • (landing) 落地页   │ │  • /api/email/*   │ │                 │
    │                     │ │                  │ │                 │
    └─────────────────────┘ └──────────────────┘ └─────────────────┘
                                   │
                 ┌─────────────────┼─────────────────┐
                 │                 │                 │
                 ▼                 ▼                 ▼
    ┌─────────────────────┐ ┌──────────────┐ ┌───────────────┐
    │                     │ │              │ │               │
    │   核心基础设施层     │ │  共享服务层  │ │   扩展系统层  │
    │   (Core Layer)      │ │ (Shared)     │ │ (Extensions)  │
    │                     │ │              │ │               │
    │  • Auth  认证系统   │ │  • Models    │ │  • AI         │
    │  • DB    数据库抽象 │ │  • Services  │ │  • Payment    │
    │  • I18n 国际化      │ │  • Blocks    │ │  • Email      │
    │  • RBAC 权限控制    │ │  • Components│ │  • Storage    │
    │  • Theme 主题系统   │ │  • Hooks     │ │  • Analytics  │
    │                     │ │  • Lib       │ │  • Ads        │
    │                     │ │              │ │  • Affiliate  │
    └─────────────────────┘ └──────────────┘ └───────────────┘
                 │                 │                 │
                 └─────────────────┼─────────────────┘
                                   │
                 ┌─────────────────┼─────────────────┐
                 │                 │                 │
                 ▼                 ▼                 ▼
    ┌─────────────────────┐ ┌──────────────┐ ┌───────────────┐
    │                     │ │              │ │               │
    │   配置系统          │ │  数据库层    │ │   外部服务    │
    │   (Config)          │ │  (Database)  │ │  (External)   │
    │                     │ │              │ │               │
    │  • 环境变量         │ │  PostgreSQL  │ │  OpenAI       │
    │  • 数据库配置       │ │  MySQL       │ │  Anthropic    │
    │  • 混合配置系统     │ │  SQLite/Turso│ │  Stripe       │
    │                     │ │              │ │  Resend       │
    │                     │ │              │ │  Cloudflare   │
    └─────────────────────┘ └──────────────┘ └───────────────┘
```

---

## 目录结构详解

```
shipany-template/
│
├── src/
│   ├── app/[locale]/                # Next.js App Router + 国际化
│   │   ├── (admin)/                 # 管理后台路由组
│   │   │   └── admin/
│   │   │       ├── users/           # 用户管理
│   │   │       ├── posts/           # 内容管理
│   │   │       ├── categories/      # 分类管理
│   │   │       ├── payments/        # 支付记录
│   │   │       ├── subscriptions/   # 订阅管理
│   │   │       ├── credits/         # 积分管理
│   │   │       ├── apikeys/         # API密钥管理
│   │   │       ├── ai-tasks/        # AI任务管理
│   │   │       ├── roles/           # 角色管理
│   │   │       ├── permissions/     # 权限管理
│   │   │       └── settings/        # 系统设置
│   │   │
│   │   ├── (auth)/                  # 认证路由组
│   │   │   ├── sign-in/
│   │   │   ├── sign-up/
│   │   │   └── verify-email/
│   │   │
│   │   ├── (chat)/                  # 聊天功能路由组
│   │   │   └── chat/
│   │   │
│   │   ├── (docs)/                  # 文档路由组
│   │   │   └── docs/
│   │   │
│   │   ├── (landing)/               # 落地页路由组
│   │   │   ├── [..slug]/            # 动态页面
│   │   │   ├── pricing/
│   │   │   └── settings/
│   │   │
│   │   └── api/                     # API 路由
│   │       ├── auth/[...all]/       # Better Auth
│   │       ├── ai/generate/         # AI 生成
│   │       ├── chat/                # 聊天 API
│   │       ├── payment/             # 支付回调
│   │       ├── storage/             # 文件上传
│   │       └── email/               # 邮件发送
│   │
│   ├── core/                        # 核心基础设施
│   │   ├── auth/                    # Better Auth 认证
│   │   ├── db/                      # 数据库抽象层
│   │   │   ├── index.ts             # 通用 db() + 方言兼容
│   │   │   ├── postgres.ts          # PostgreSQL
│   │   │   ├── mysql.ts             # MySQL
│   │   │   └── sqlite.ts            # SQLite/Turso
│   │   ├── i18n/                    # 国际化 (next-intl)
│   │   ├── rbac/                    # 权限控制 (RBAC)
│   │   ├── theme/                   # 主题系统
│   │   └── docs/                    # 文档配置
│   │
│   ├── config/                      # 静态配置
│   │   ├── index.ts                 # 环境变量配置
│   │   ├── db/                      # 数据库配置
│   │   │   ├── schema.ts            # Schema 入口
│   │   │   └── migrations/          # 迁移文件
│   │   └── locale/                  # 翻译文件
│   │       ├── en/                  # 英文
│   │       └── zh/                  # 中文
│   │
│   ├── extensions/                  # 扩展系统
│   │   ├── ai/                      # AI 服务
│   │   │   ├── index.ts             # AIManager
│   │   │   ├── types.ts             # Provider 接口
│   │   │   ├── kie.ts               # Kie.ai
│   │   │   ├── replicate.ts         # Replicate
│   │   │   ├── fal.ts               # Fal.ai
│   │   │   └── gemini.ts            # Gemini
│   │   │
│   │   ├── payment/                 # 支付服务
│   │   │   ├── index.ts             # PaymentManager
│   │   │   ├── stripe.ts            # Stripe
│   │   │   ├── creem.ts             # Creem
│   │   │   └── paypal.ts            # PayPal
│   │   │
│   │   ├── email/                   # 邮件服务
│   │   │   └── resend.ts            # Resend
│   │   │
│   │   ├── storage/                 # 存储服务
│   │   │   ├── r2.ts                # Cloudflare R2
│   │   │   └── s3.ts                # AWS S3
│   │   │
│   │   ├── analytics/               # 分析服务
│   │   │   ├── google.ts
│   │   │   ├── clarity.ts
│   │   │   └── vercel.ts
│   │   │
│   │   ├── ads/                     # 广告服务
│   │   │   └── adsense.ts           # Google AdSense
│   │   │
│   │   ├── affiliate/               # 联盟营销
│   │   │   ├── affonso.ts
│   │   │   └── promotekit.ts
│   │   │
│   │   └── customer-service/        # 客服服务
│   │       ├── crisp.ts
│   │       └── tawk.ts
│   │
│   ├── shared/                      # 共享层
│   │   ├── models/                  # 数据模型层
│   │   │   ├── config.ts            # 配置模型
│   │   │   ├── user.ts              # 用户模型
│   │   │   ├── credit.ts            # 积分模型
│   │   │   ├── order.ts             # 订单模型
│   │   │   ├── subscription.ts      # 订阅模型
│   │   │   ├── post.tsx             # 文章模型
│   │   │   ├── chat.ts              # 聊天模型
│   │   │   └── ai_task.ts           # AI任务模型
│   │   │
│   │   ├── services/                # 业务服务层
│   │   │   ├── settings.ts          # 设置服务
│   │   │   ├── ai.ts                # AI 服务
│   │   │   ├── payment.ts           # 支付服务
│   │   │   ├── storage.ts           # 存储服务
│   │   │   ├── email.ts             # 邮件服务
│   │   │   └── rbac.ts              # RBAC 服务
│   │   │
│   │   ├── blocks/                  # 可复用 UI 块
│   │   │   ├── chat/
│   │   │   ├── dashboard/
│   │   │   ├── generator/
│   │   │   ├── payment/
│   │   │   └── table/
│   │   │
│   │   ├── components/              # React 组件库
│   │   │   ├── ui/                  # Radix UI 组件
│   │   │   ├── magicui/             # Magic UI 组件
│   │   │   └── ai-elements/         # AI Elements 组件
│   │   │
│   │   ├── hooks/                   # React Hooks
│   │   ├── lib/                     # 工具函数
│   │   └── types/                   # TypeScript 类型
│   │
│   └── themes/                      # 主题系统
│       └── default/
│           ├── blocks/              # 主题特定组件
│           ├── layouts/             # 主题布局
│           └── pages/               # 主题页面
│
├── content/                         # MDX 内容管理
│   ├── docs/                        # 文档 (Fumadocs)
│   ├── posts/                       # 博客文章
│   ├── logs/                        # 更新日志
│   └── pages/                       # 静态页面
│
├── public/                          # 静态资源
└── scripts/                         # 构建脚本
```

---

## 数据流架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          用户请求 / 用户操作                              │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                       Next.js App Router                                │
│                   (src/app/[locale]/)                                   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    路由层                    │   │
│  │  • 路由组 (admin/auth/chat/docs/landing)                        │   │
│  │  • 路由守卫                       │   │
│  │  • 中间件                               │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                      API 路由 / 服务端组件                               │
│                   (app/api/* 或 page.tsx)                               │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    请求处理层                  │   │
│  │  1. 获取用户会话               │   │
│  │  2. 权限验证              │   │
│  │  3. 参数校验                 │   │
│  │  4. 调用服务层                          │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         服务层 (Shared Services)                        │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  getAllConfigs() ──→ 获取配置                                   │   │
│  │         │                                                       │   │
│  │         ├─→ 环境变量                          │   │
│  │         └─→ 数据库配置                              │   │
│  │                                                                 │   │
│  │  get[Service]() ──→ 初始化扩展                                │   │
│  │         │                                                       │   │
│  │         └─→ AIManager / PaymentManager / ...                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                ┌───────────────────┴───────────────────┐
                │                                       │
                ▼                                       ▼
┌───────────────────────────┐           ┌───────────────────────────────┐
│      扩展层 (Extensions)    │           │      模型层 (Models)         │
│                            │           │                               │
│  ┌──────────────────────┐ │           │  ┌────────────────────────┐  │
│  │   AIManager          │ │           │  │  user.ts               │  │
│  │   • kie/replicate/fal │ │           │  │  order.ts              │  │
│  │   • gemini/openrouter │ │           │  │  subscription.ts       │  │
│  ├──────────────────────┤ │           │  │  credit.ts             │  │
│  │  PaymentManager      │ │           │  │  post.tsx              │  │
│  │   • stripe/creem/paypal│ │           │  └────────────────────────┘  │
│  ├──────────────────────┤ │           └───────────────────────────────┘
│  │  EmailManager        │
│  │   • resend           │
│  ├──────────────────────┤
│  │  StorageManager      │
│  │   • r2/s3            │
│  └──────────────────────┘
└───────────────────────────┘
                │
                └───────────────┬───────────────────────┐
                                │                       │
                                ▼                       ▼
┌───────────────────────────────────────┐   ┌─────────────────────────────┐
│         数据库层 (DB Layer)            │   │       外部 API 层           │
│                                       │   │                             │
│  ┌─────────────────────────────────┐ │   │  • OpenAI / Anthropic       │
│  │  db() - 通用访问器              │ │   │  • Stripe / PayPal          │
│  │                                 │ │   │  • Resend                   │
│  │  ┌───────────────────────────┐  │ │   │  • Cloudflare R2            │
│  │  │ 方言兼容层       │  │ │   │                             │
│  │  │                         │  │ │   └─────────────────────────────┘
│  │  │ • PostgreSQL            │  │ │
│  │  │ • MySQL                 │  │ │
│  │  │ • SQLite/Turso          │  │ │
│  │  │                         │  │ │
│  │  │ ┌─────────────────────┐ │  │ │
│  │  │ │ Drizzle ORM        │ │  │ │
│  │  │ └─────────────────────┘ │  │ │
│  │  └───────────────────────────┘  │ │
│  └─────────────────────────────────┘ │
└───────────────────────────────────────┘
```

---

## 扩展系统架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         扩展系统                          │
└─────────────────────────────────────────────────────────────────────────┘

                              接口定义
                        ┌──────────────┐
                        │ Provider     │
                        │ Interface    │
                        └──────┬───────┘
                               │
            ┌──────────────────┼──────────────────┐
            │                  │                  │
            ▼                  ▼                  ▼
    ┌─────────────┐   ┌─────────────┐   ┌─────────────┐
    │ AIProvider  │   │ Payment     │   │ Email       │
    │             │   │ Provider    │   │ Provider    │
    │• generate   │   │             │   │             │
    │  Text       │   │• create     │   │• sendEmail  │
    │• generate   │   │  Payment    │   │• sendBulk   │
    │  Image      │   │• getEvent   │   │             │
    │• stream     │   │• webhook    │   │             │
    └──────┬──────┘   └──────┬──────┘   └──────┬──────┘
           │                 │                 │
           ▼                 ▼                 ▼
    ┌─────────────┐   ┌─────────────┐   ┌─────────────┐
    │ AIManager   │   │ Payment     │   │ Email       │
    │             │   │ Manager     │   │ Manager     │
    │• addProvider│   │             │   │             │
    │• getProvider│   │• addProvider│   │• addProvider│
    │• getDefault │   │• getProvider│   │• getProvider│
    └──────┬──────┘   └──────┬──────┘   └──────┬──────┘
           │                 │                 │
           ▼                 ▼                 ▼
    ┌─────────────────────────────────────────────────────┐
    │                  提供商实现                 │
    ├─────────────────────────────────────────────────────┤
    │ AI:     kie, replicate, fal, gemini, openrouter     │
    │ Payment: stripe, creem, paypal                       │
    │ Email:   resend                                      │
    │ Storage: r2, s3                                      │
    └─────────────────────────────────────────────────────┘
```

---

## 配置系统架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      配置系统                      │
└─────────────────────────────────────────────────────────────────────────┘

                      ┌─────────────────┐
                      │   .env 文件      │
                      │ (环境变量)       │
                      └────────┬────────┘
                               │
                               ▼
                      ┌─────────────────┐
                      │  envConfigs     │
                      │  (config/index) │
                      └────────┬────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                      getAllConfigs()                                    │
│                 (shared/models/config.ts)                               │
│                                                                         │
│   1. 从数据库读取 config 表                                              │
│   2. 与环境变量合并                                                       │
│   3. 环境变量优先级更高                                                   │
│   4. 缓存结果 (unstable_cache + revalidateTag)                          │
└─────────────────────────────────────────────────────────────────────────┘
                               │
                ┌──────────────┼──────────────┐
                │              │              │
                ▼              ▼              ▼
         ┌──────────┐   ┌──────────┐   ┌──────────┐
         │ 服务层   │   │ 扩展层   │   │ 客户端   │
         │ 获取配置 │   │ 初始化   │   │ 公开配置 │
         └──────────┘   └──────────┘   └──────────┘
```

---

## 认证与权限架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                 认证与权限系统 (Auth + RBAC)                             │
└─────────────────────────────────────────────────────────────────────────┘

                      用户登录请求
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        Better Auth                                       │
│                        (core/auth/)                                      │
│                                                                         │
│  • 邮箱/密码登录                                                         │
│  • Google OAuth                                                         │
│  • GitHub OAuth                                                         │
│  • 邮箱验证 (Resend)                                                     │
└─────────────────────────────────────────────────────────────────────────┘
                           │
                           ▼
                    生成用户会话
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                      权限检查层                      │
│                      (core/rbac/)                                        │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  requirePermission(permission)                                  │   │
│  │  requireRole(role)                                              │   │
│  │  requireAdminAccess()                                           │   │
│  │  checkPermission(user, permission)                              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                           │
              ┌────────────┴────────────┐
              │                         │
              ▼                         ▼
         允许访问                    拒绝/重定向
```

---

## 主题系统架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        主题系统                        │
└─────────────────────────────────────────────────────────────────────────┘

                    NEXT_PUBLIC_THEME
                       环境变量
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                     主题加载器 (core/theme/)                             │
│                                                                         │
│  • getThemePage(theme, page)   ──→ 加载主题页面                         │
│  • getThemeLayout(theme, layout) ──→ 加载主题布局                       │
│  • getThemeBlock(theme, block)  ──→ 加载主题组件块                     │
│                                                                         │
│  • 自动回退到 'default' 主题                                             │
│  • 支持动态主题切换                                                      │
└─────────────────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                      主题目录结构                                        │
│                                                                         │
│  themes/                                                                │
│  ├── default/                    # 默认主题                             │
│  │   ├── blocks/                 # 主题特定组件块                       │
│  │   ├── layouts/                # 主题布局                            │
│  │   │   ├── landing.tsx         # 落地页布局                          │
│  │   │   ├── admin.tsx           # 管理后台布局                        │
│  │   │   ├── docs.tsx            # 文档布局                            │
│  │   │   └── simple.tsx          # 简单布局                            │
│  │   └── pages/                  # 主题特定页面                         │
│  │                                                               │
│  └── [custom-theme]/            # 自定义主题                           │
│      └── ...                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 数据库 Schema

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        数据库表结构                                      │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│  用户与认证                                   │
├─────────────────────────────────────────────────────────────────────────┤
│  • user          - 用户信息                                              │
│  • session       - 用户会话                                              │
│  • account       - OAuth 账户关联                                        │
│  • verification  - 邮箱验证码                                            │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│  内容管理                                     │
├─────────────────────────────────────────────────────────────────────────┤
│  • taxonomy      - 分类/标签                                             │
│  • post          - 文章/内容                                             │
│  • post_taxonomy - 文章分类关联                                          │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│  支付与订阅                                 │
├─────────────────────────────────────────────────────────────────────────┤
│  • order         - 订单                                                  │
│  • subscription  - 订阅                                                  │
│  • credit        - 积分记录                                              │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│  AI 与聊天                                   │
├─────────────────────────────────────────────────────────────────────────┤
│  • chat          - 聊天会话                                              │
│  • chat_message  - 聊天消息                                              │
│  • ai_task       - AI 任务                                              │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│  系统配置                                               │
├─────────────────────────────────────────────────────────────────────────┤
│  • config        - 系统配置 (键值对存储)                                  │
│  • apikey        - API 密钥                                              │
│  • role          - RBAC 角色                                            │
│  • permission    - RBAC 权限                                            │
│  • user_role     - 用户角色关联                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 关键文件映射

| 功能模块 | 关键文件 |
|---------|---------|
| **数据库访问** | [src/core/db/index.ts](src/core/db/index.ts) |
| **环境配置** | [src/config/index.ts](src/config/index.ts) |
| **配置模型** | [src/shared/models/config.ts](src/shared/models/config.ts) |
| **认证系统** | [src/core/auth/index.ts](src/core/auth/index.ts) |
| **权限控制** | [src/core/rbac/permission.ts](src/core/rbac/permission.ts) |
| **主题系统** | [src/core/theme/index.ts](src/core/theme/index.ts) |
| **AI 管理** | [src/extensions/ai/index.ts](src/extensions/ai/index.ts) |
| **支付管理** | [src/extensions/payment/index.ts](src/extensions/payment/index.ts) |
| **AI 服务** | [src/shared/services/ai.ts](src/shared/services/ai.ts) |
| **支付服务** | [src/shared/services/payment.ts](src/shared/services/payment.ts) |
| **设置服务** | [src/shared/services/settings.ts](src/shared/services/settings.ts) |

---

## 架构特点

1. **方言无关数据库访问** - 通过 `db()` 函数支持 PostgreSQL、MySQL、SQLite/Turso
2. **模块化扩展系统** - 统一的 Provider 接口，易于添加新服务
3. **混合配置系统** - 环境变量 + 数据库配置，灵活性强
4. **完善 RBAC** - 细粒度权限控制
5. **国际化支持** - 基于 next-intl 的多语言路由
6. **动态主题系统** - 支持多主题和主题切换
7. **类型安全** - 全面使用 TypeScript 和 Drizzle 推断类型
